!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).FetchStreamer=e()}(this,(function(){"use strict";function t(t,e,i,n){return new(i||(i=Promise))((function(r,s){function h(t){try{o(n.next(t))}catch(t){s(t)}}function u(t){try{o(n.throw(t))}catch(t){s(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,u)}o((n=n.apply(t,e||[])).next())}))}function e(t,e){var i,n,r,s,h={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function u(s){return function(u){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;h;)try{if(i=1,n&&(r=2&s[0]?n.return:s[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return h.label++,{value:s[1],done:!1};case 5:h.label++,n=s[1],s=[0];continue;case 7:s=h.ops.pop(),h.trys.pop();continue;default:if(!(r=h.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){h=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){h.label=s[1];break}if(6===s[0]&&h.label<r[1]){h.label=r[1],r=s;break}if(r&&h.label<r[2]){h.label=r[2],h.ops.push(s);break}r[2]&&h.ops.pop(),h.trys.pop();continue}s=e.call(t,h)}catch(t){s=[6,t],n=0}finally{i=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}return function(){function i(t,e,i){void 0===i&&(i=null),this.originalChunkSize=0,this.targetChunkSize=0,this.url="",this.chunkBuffer=null,this.reader=null,this.decodedChunkData=null,this.textDecoder=null,this.callbackOnFinish=function(){},this.callbackOnData=function(){},this.startedAt=0,this.canReadNextChunk=!0,this.writtenBufferSize=0,this.receivedBytes=0,this.processedBytes=0,this.unconsumedBytes=0,this.writableLength=0,this.currentWriteLength=0,this.writingPosition=0,this.originalChunkSize=e,this.targetChunkSize=e,this.url=t,this.chunkBuffer=new Uint8Array(e),this.readerCallback=this.readerCallback.bind(this),i&&(this.textDecoder=new TextDecoder(i))}return i.prototype.onFinish=function(t){this.callbackOnFinish=t},i.prototype.onData=function(t){this.callbackOnData=t},i.prototype.resetBuffer=function(t){this.targetChunkSize=+t,this.chunkBuffer=new Uint8Array(this.targetChunkSize)},i.prototype.chunked=function(t){if(void 0===t&&(t=!1),this.processedBytes+=this.writtenBufferSize,this.decodedChunkData=t?this.chunkBuffer.slice(0,this.writtenBufferSize):this.chunkBuffer,this.textDecoder&&(this.decodedChunkData=this.textDecoder.decode(this.decodedChunkData)),!t||0!==this.decodedChunkData.length){var e=this.callbackOnData.call(this.callbackOnData,this.decodedChunkData,{targetSize:this.targetChunkSize,fulfilled:this.writtenBufferSize===this.targetChunkSize});e>0&&this.resetBuffer(e),this.chunkBuffer.fill(0),this.writtenBufferSize=0}},i.prototype.ended=function(){this.callbackOnFinish.call(this.callbackOnFinish,{bytesReceived:this.receivedBytes,bytesProcessed:this.processedBytes,elapsed:Date.now()-this.startedAt})},i.prototype.process=function(t){for(this.unconsumedBytes=t.length;this.unconsumedBytes>0;)this.writableLength=this.targetChunkSize-this.writtenBufferSize,this.currentWriteLength=this.unconsumedBytes>this.writableLength?this.writableLength:this.unconsumedBytes,this.writingPosition=t.length-this.unconsumedBytes,this.chunkBuffer.set(t.slice(this.writingPosition,this.writingPosition+this.currentWriteLength),this.writtenBufferSize),this.writtenBufferSize+=this.currentWriteLength,this.unconsumedBytes-=this.currentWriteLength,this.writtenBufferSize===this.targetChunkSize&&this.chunked()},i.prototype.pause=function(){this.canReadNextChunk=!1},i.prototype.resume=function(){this.canReadNextChunk=!0,this.next()},i.prototype.next=function(){this.canReadNextChunk&&this.reader.read().then(this.readerCallback)},i.prototype.readerCallback=function(t){var e=t.value;t.done?(this.chunked(!0),this.ended()):(this.process(e),this.receivedBytes+=e.length,this.next())},i.prototype.start=function(){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return this.startedAt=Date.now(),t=this,[4,fetch(this.url).then((function(t){return t.body.getReader()}))];case 1:return t.reader=e.sent(),this.next(),[2]}}))}))},i}()}));
